{% extends 'base.html' %}
{% load static %}

{% block title %}Бронирование рейса {{ flight.route.route_no }}{% endblock %}

{% block content %}
<div class="booking-container">
    <h1><i class="fas fa-ticket-alt"></i> Бронирование рейса</h1>

    <div class="card" style="background: #e7f3ff; border-left: 4px solid #007bff;">
        <h3>Информация о рейсе</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 15px;">
            <div>
                <strong>Маршрут:</strong><br>
                {{ flight.route.departure_airport.city.ru|default:flight.route.departure_airport.airport_code }}
                →
                {{ flight.route.arrival_airport.city.ru|default:flight.route.arrival_airport.airport_code }}
            </div>
            <div>
                <strong>Вылет:</strong><br>
                {{ flight.scheduled_departure|date:"d.m.Y H:i" }}
            </div>
            <div>
                <strong>Прилет:</strong><br>
                {{ flight.scheduled_arrival|date:"d.m.Y H:i" }}
            </div>
            <div>
                <strong>Базовая цена:</strong><br>
                <span id="display-price" style="font-size: 1.5rem; color: #28a745; font-weight: bold;">{{ base_price }} ₽</span>
            </div>
        </div>
        <div>
            <strong>Самолет:</strong> {{ flight.route.airplane.model.en }} ({{ flight.route.airplane.airplane_code }})
        </div>
    </div>

    <div class="card">
        <h3>Данные пассажира</h3>
        <form method="post">
            {% csrf_token %}

            <div class="form-row">
                <div class="form-group">
                    <label for="passenger_name">ФИО пассажира *</label>
                    <input type="text" id="passenger_name" name="passenger_name" class="form-control"
                           value="{{ user.last_name }} {{ user.first_name }}" required>
                </div>

                <div class="form-group">
                    <label for="passenger_id">Номер документа *</label>
                    <input type="text" id="passenger_id" name="passenger_id" class="form-control"
                           placeholder="Серия и номер паспорта" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="seat">Место (пример)</label>
                    <select id="seat" name="seat" class="form-control">
                        <option value="Auto">Автоматическое назначение</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="fare_conditions">Класс обслуживания</label>
                    <select id="fare_conditions" name="fare_conditions" class="form-control">
                        <option value="Economy" data-factor="1">Эконом - {{ base_price }} ₽</option>
                        <option value="Comfort" data-factor="1.5">Комфорт - {% widthratio base_price 2 3 %} ₽</option>
                        <option value="Business" data-factor="3">Бизнес - {% widthratio base_price 1 3 %} ₽</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>
                    <input type="checkbox" name="terms" required>
                    Я согласен с правилами перевозки *
                </label>
            </div>

            <div style="display: flex; gap: 20px; margin-top: 30px;">
                <a href="{% url 'flight_search' %}" class="btn btn-secondary" style="flex: 1;">
                    <i class="fas fa-arrow-left"></i> Отмена
                </a>
                <button type="submit" class="btn" style="flex: 2;">
                    <i class="fas fa-credit-card"></i> Оплатить бронирование
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    const basePrice = {{ base_price }};
    const select = document.getElementById('fare_conditions');
    const display = document.getElementById('display-price');

    select.addEventListener('change', function() {
        const factor = parseFloat(this.options[this.selectedIndex].dataset.factor);
        const newPrice = Math.round(basePrice * factor);
        display.textContent = newPrice + ' ₽';
    });
</script>
{% endblock %}