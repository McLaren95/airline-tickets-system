{% extends 'base.html' %}
{% load static %}

{% block title %}Поиск рейсов - SkyTickets{% endblock %}

{% block content %}
    <h1 style="margin-bottom: 30px;"><i class="fas fa-search"></i> Поиск рейсов</h1>

    <div class="card" style="padding: 30px; background: white;">
        <form method="get" action="{% url 'flight_search' %}" autocomplete="off">
            <div class="form-row">

                <div class="form-group">
                    <label for="departure"><i class="fas fa-plane-departure"></i> Откуда</label>
                    <input type="text" id="departure" name="departure" class="form-control"
                           placeholder="Начните вводить (Москва...)"
                           value="{{ request.GET.departure }}"
                           list="airports-list"
                           oninput="searchAirports(this.value)">
                </div>

                <div class="form-group">
                    <label for="arrival"><i class="fas fa-plane-arrival"></i> Куда</label>
                    <input type="text" id="arrival" name="arrival" class="form-control"
                           placeholder="Начните вводить (Сочи...)"
                           value="{{ request.GET.arrival }}"
                           list="airports-list"
                           oninput="searchAirports(this.value)">
                </div>

                <div class="form-group">
                    <label for="date"><i class="fas fa-calendar-alt"></i> Дата вылета</label>
                    <input type="date" id="date" name="date" class="form-control"
                           value="{{ request.GET.date }}">
                </div>
            </div>

            <datalist id="airports-list"></datalist>

            <button type="submit" class="btn" style="width: 100%; font-size: 1.1rem; padding: 12px; margin-top: 10px;">
                <i class="fas fa-search"></i> Найти рейсы
            </button>
        </form>
    </div>

    {% if flights %}
        <div class="results">
            <h3 style="margin: 30px 0 20px 0; color: #444;">
                <i class="fas fa-plane"></i> Найдено рейсов: {{ flights|length }}
            </h3>

            {% for flight in flights %}
                <div class="card flight-card" style="margin-bottom: 20px; border-left: 5px solid #007bff; padding: 25px; overflow: hidden;">
                    <div style="display: flex; justify-content: space-between; align-items: stretch; flex-wrap: wrap; gap: 25px;">

                        <div style="flex: 10; min-width: 280px;">
                            <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 15px;">
                                <h2 style="margin: 0; color: #0056b3; font-size: 2rem;">
                                    {{ flight.scheduled_departure|date:"H:i" }}
                                </h2>

                                <div style="flex: 1; text-align: center; position: relative; max-width: 150px;">
                                    <div style="border-bottom: 2px solid #ccc; width: 100%; position: absolute; top: 50%;"></div>
                                    <span style="background: white; padding: 0 10px; position: relative; z-index: 1; font-size: 0.85rem; color: #777;">
                                        {{ flight.route.duration }}
                                    </span>

                                </div>

                                <h2 style="margin: 0; color: #0056b3; font-size: 2rem;">
                                    {{ flight.scheduled_arrival|date:"H:i" }}
                                </h2>
                            </div>

                            <div style="display: flex; justify-content: space-between; font-size: 1rem; color: #333; font-weight: 500;">
                                <span>
                                    {{ flight.route.departure_airport.city.ru|default:flight.route.departure_airport.airport_code }}
                                    <span style="color: #666; font-weight: normal;">({{ flight.route.departure_airport.airport_code }})</span>
                                </span>
                                <span>
                                    {{ flight.route.arrival_airport.city.ru|default:flight.route.arrival_airport.airport_code }}
                                    <span style="color: #666; font-weight: normal;">({{ flight.route.arrival_airport.airport_code }})</span>
                                </span>
                            </div>

                            <hr style="border: 0; border-top: 1px solid #eee; margin: 15px 0;">

                            <p style="margin: 0; color: #666; font-size: 0.9rem;">
                                <i class="far fa-calendar"></i> {{ flight.scheduled_departure|date:"d E Y" }}
                                &nbsp;|&nbsp;
                                <i class="fas fa-plane"></i> {{ flight.route.airplane.model.en|default:flight.route.airplane.model }}
                            </p>
                        </div>

                        <div style="text-align: right; flex: 1; min-width: 200px; display: flex; flex-direction: column; justify-content: space-between; border-left: 1px solid #eee; padding-left: 20px;">

                            <div style="margin-bottom: 15px;">
                                <span class="status-badge
                                    {% if flight.status == 'Scheduled' %}status-scheduled
                                    {% elif flight.status == 'Delayed' %}status-delayed
                                    {% elif flight.status == 'Departed' %}status-departed
                                    {% else %}status-arrived{% endif %}">
                                    {{ flight.get_status_display }}
                                </span>
                            </div>

                            <div>
                                <div style="font-size: 1.8rem; font-weight: bold; color: #28a745; margin-bottom: 15px;">
                                    от 5 500 ₽
                                </div>

                                {% if user.is_authenticated %}
                                    <a href="{% url 'book_flight' flight.flight_id %}" class="btn" style="width: 90%; display: block; text-align: center;">
                                        Купить билет
                                    </a>
                                {% else %}
                                    <a href="{% url 'login' %}?next={% url 'book_flight' flight.flight_id %}" class="btn btn-secondary" style="width: 90%; display: block; text-align: center;">
                                        Войти
                                    </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>

    {% elif request.GET %}
        <div class="card" style="text-align: center; padding: 50px; margin-top: 30px;">
            <i class="fas fa-search-location" style="font-size: 4rem; color: #ddd; margin-bottom: 20px;"></i>
            <h3>Рейсы не найдены</h3>
            <p style="color: #666;">Попробуйте изменить дату или параметры поиска.</p>
            <a href="{% url 'flight_search' %}" class="btn btn-secondary" style="margin-top: 20px;">Очистить фильтры</a>
        </div>
    {% endif %}
{% endblock %}

{% block scripts %}
<style>
.status-badge {
    display: inline-block;
    padding: 6px 15px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
}
.status-scheduled { background: #d4edda; color: #155724; }
.status-delayed { background: #fff3cd; color: #856404; }
.status-departed { background: #cce5ff; color: #004085; }
.status-arrived { background: #e2e3e5; color: #383d41; }

.flight-card {
    transition: transform 0.2s, box-shadow 0.2s;
}
.flight-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 20px rgba(0,0,0,0.05) !important;
}

@media (max-width: 768px) {
    .flight-card > div {
        flex-direction: column;
    }
    .flight-card div[style*="border-left"] {
        border-left: none !important;
        padding-left: 0 !important;
        border-top: 1px solid #eee;
        padding-top: 20px;
        margin-top: 15px;
        text-align: center !important;
    }
    .status-badge {
        float: none !important;
    }
}
</style>

<script>
    let timeout = null;

    function searchAirports(value) {
        if (value.length < 2) return;

        clearTimeout(timeout);

        timeout = setTimeout(() => {
            fetch(`/api/airports/?term=${encodeURIComponent(value)}`)
                .then(response => {
                    if (!response.ok) throw new Error('Network error');
                    return response.json();
                })
                .then(data => {
                    const list = document.getElementById('airports-list');
                    list.innerHTML = '';

                    data.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item.label;
                        list.appendChild(option);
                    });
                })
                .catch(error => console.error('Error:', error));
        }, 300);
    }
</script>
{% endblock %}